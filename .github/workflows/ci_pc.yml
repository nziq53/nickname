on: [push, pull_request]

jobs:
    build_cache:
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                release:
                    - { name: release }
                    - { name: debug }
                version: [1.68.0, stable, beta, nightly]
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0
            - uses: ./.github/actions/install_rust_by_version
            - uses: ./.github/actions/cache_cargo
            - name: build
              run: cargo build
            - uses: ./.github/actions/rm_cache_cargo

    fmt:
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                release:
                    - { name: debug }
                version: [1.68.0, stable, beta, nightly]
        runs-on: ${{ matrix.os }}
        needs: build_cache
        steps:
            - uses: actions/checkout@v3
            - run: rustup component add rustfmt
            - uses: ./.github/actions/install_rust_by_version
            - uses: ./.github/actions/cache_cargo
            - name: install fmt
              run: rustup component add rustfmt
            - name: fmt
              run: cargo fmt --all -- --check
            - uses: ./.github/actions/rm_cache_cargo

    clippy:
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                release:
                    - { name: debug }
                version: [1.68.0, stable, beta, nightly]
        runs-on: ${{ matrix.os }}
        env:
            RUSTC_FORCE_INCREMENTAL: 1
        needs: build_cache
        steps:
            - uses: actions/checkout@v3
            - run: rustup component add clippy
            - uses: ./.github/actions/install_rust_by_version
            - uses: ./.github/actions/cache_cargo
            - name: install clippy
              run: rustup component add clippy-preview
            - name: clippy
              run: cargo clippy --all-targets --all-features -- -D warnings
            - uses: ./.github/actions/rm_cache_cargo

    test:
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                release:
                    - { name: release }
                    - { name: debug }
                version: [1.68.0, stable, beta, nightly]
        runs-on: ${{ matrix.os }}
        needs: build_cache
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/install_rust_by_version
            - uses: ./.github/actions/cache_cargo
            - name: test release
              if: matrix.release.name == 'release'
              run: cargo test --all --release -- --nocapture
            - name: test debug
              if: matrix.release.name == 'debug'
              run: cargo test --all -- --nocapture
            - uses: ./.github/actions/rm_cache_cargo

    run:
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                release:
                    - { name: release }
                    - { name: debug }
                version: [1.68.0, stable, beta, nightly]
        runs-on: ${{ matrix.os }}
        needs: build_cache
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/install_rust_by_version
            - uses: ./.github/actions/cache_cargo
            - name: run release
              if: matrix.release.name == 'release'
              run: |
                  cargo build --release
                  cargo run --release > ${{ runner.os }}-${{ runner.version }}-${{ runner.release.name }}-run.log
              working-directory: ./examples/pc
            - name: run debug
              if: matrix.release.name == 'debug'
              run: |
                  cargo build
                  cargo run > ${{ runner.os }}-${{ runner.version }}-${{ runner.release.name }}-run.log
              working-directory: ./examples/pc
            - uses: ./.github/actions/rm_cache_cargo
            - name: Upload log on run
              uses: actions/upload-artifact@v1
              with:
                  name: ./examples/pc/${{ runner.os }}-${{ runner.version }}-${{ runner.release.name }}-run.log
                  path: ${{ runner.os }}-${{ runner.version }}-${{ runner.release.name }}-run.log

    concat_logs:
        runs-on: ubuntu-latest
        needs: [build_cache, run]
        steps:
            - name: Concatenate logs
              run: |
                  cat ubuntu-latest-1.68.0-release-run.log > all-logs.txt
                  cat ubuntu-latest-1.68.0-debug-run.log >> all-logs.txt
                  cat ubuntu-latest-stable-release-run.log >> all-logs.txt
                  cat ubuntu-latest-stable-debug-run.log >> all-logs.txt
                  cat ubuntu-latest-beta-release-run.log >> all-logs.txt
                  cat ubuntu-latest-beta-debug-run.log >> all-logs.txt
                  cat ubuntu-latest-nightly-release-run.log >> all-logs.txt
                  cat ubuntu-latest-nightly-debug-run.log >> all-logs.txt

            - name: Upload concatenated log
              uses: actions/upload-artifact@v2
              with:
                  name: all-logs
                  path: all-logs.txt
# https://zenn.dev/naokifujita/articles/c890954165c21f
# https://github.com/actix/actix-web/blob/master/.github/workflows/ci.yml
